# Инцидент: Vite dev-сервер недоступен через localhost при активном VPN

**Дата:** 2026-01-15
**Проект:** TGBotSettingsViewer
**Статус:** ✅ Решено

---

## Симптомы

- Vite dev-сервер успешно запускается (`VITE v7.3.1 ready in 1007 ms`)
- В терминале показывает `Local: http://localhost:5173/`
- При открытии в браузере: **"This site can't be reached - localhost refused to connect"**
- Ошибка: `ERR_CONNECTION_REFUSED`

**Воспроизводится на:**
- ОС: Windows
- Node.js: v24.12.0
- VPN: активен (выключить нельзя)
- Браузер: Chrome/Edge

---

## Окружение

```bash
# package.json
"vite": "^7.2.4"

# Запуск
npm run dev

# Вывод терминала
VITE v7.3.1  ready in 1007 ms
➜  Local:   http://localhost:5173/
➜  Network: use --host to expose
```

---

## Попытки решения (не сработали)

### ❌ Попытка 1: Открыть по IP вместо hostname
```
http://127.0.0.1:5173/
```
**Результат:** Аналогичная ошибка `ERR_CONNECTION_REFUSED`

### ❌ Попытка 2: Инкогнито-режим
**Результат:** Не помогло

### ❌ Попытка 3: Другой порт
```bash
npm run dev -- --port 3000
```
**Результат:** Проблема сохранилась

---

## ✅ Решение

**Запуск Vite с флагом `--host`:**

```bash
npm run dev -- --host
```

**Что изменилось:**

**До:**
```
VITE v7.3.1  ready in 1007 ms
➜  Local:   http://localhost:5173/
```

**После:**
```
VITE v7.3.1  ready in 1198 ms
➜  Local:   http://localhost:5173/
➜  Network: http://172.19.0.1:5173/
➜  Network: http://192.168.0.85:5173/
```

**Результат:**
- ✅ `http://localhost:5173/` - заработал
- ✅ `http://127.0.0.1:5173/` - заработал
- ✅ `http://192.168.0.85:5173/` - заработал

---

## Анализ причины

### Вероятная причина (90%):
**VPN конфликт с localhost loopback**

Некоторые VPN-клиенты (особенно корпоративные) перехватывают **весь** сетевой трафик, включая loopback (127.0.0.1).

**Поведение по умолчанию:**
- Vite без `--host` биндится только на `127.0.0.1:5173`
- VPN перехватывает петлевой интерфейс
- Пакеты блокируются VPN туннелем

**С флагом `--host`:**
- Vite биндится на `0.0.0.0:5173` (все интерфейсы)
- Включает физические сетевые интерфейсы (`192.168.x.x`)
- VPN не трогает трафик внутри локальной сети
- Windows правильно маршрутизирует запросы к localhost

### Альтернативные причины:

**2. Windows Firewall (10%):**
- При первом запуске Node.js Windows должен спросить разрешение
- Возможно диалог был пропущен или заблокирован VPN-клиентом
- Флаг `--host` заставил файрволл пересоздать правило

**3. Timing Issue (5%):**
- Сетевой стек Windows не готов сразу после включения VPN
- Повторный запуск с другими флагами "разбудил" интерфейсы

---

## Постоянное исправление

**Обновлён `package.json`:**

```json
{
  "scripts": {
    "dev": "vite --host",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  }
}
```

Теперь `npm run dev` автоматически запускается с флагом `--host`.

---

## Дополнительные преимущества решения

1. **Тестирование на мобильных устройствах:**
   - Можно открыть `http://192.168.0.85:5173/` с телефона/планшета в той же сети
   - Полезно для проверки адаптивности

2. **Работа в команде:**
   - Коллеги в локальной сети могут открыть dev-версию

3. **Стабильность:**
   - Не зависит от настроек VPN

---

## Проверка в будущем

Если проблема повторится на другом проекте:

1. **Проверь запускается ли с `--host`:**
   ```bash
   vite --host
   # или
   npm run dev -- --host
   ```

2. **Проверь файрволл Windows:**
   - Настройки → Брандмауэр → Разрешённые приложения
   - Должен быть разрешён `Node.js JavaScript Runtime`

3. **Проверь настройки VPN:**
   - Некоторые VPN имеют опцию "Split Tunneling" - включи её для localhost

---

## Связанные проблемы

- Аналогичная проблема может возникнуть с:
  - Backend API серверами (Express, FastAPI)
  - Базами данных (PostgreSQL, MongoDB)
  - Docker контейнерами с портами на localhost

**Решение везде одно:** биндиться на `0.0.0.0` вместо `127.0.0.1`

---

## Теги

`#vite` `#vpn` `#localhost` `#windows` `#dev-server` `#networking` `#firewall`
